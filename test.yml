name: Deploy Helm Chart to GKE

on:
  push:
    paths:
      - 'charts/my-app/**' # my-appãƒãƒ£ãƒ¼ãƒˆã«å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    branches:
      - aaa-001             # aaa-001ãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã§ãƒˆãƒªã‚¬ãƒ¼

env:
  GCP_PROJECT_ID: your-gcp-project-id
  GKE_CLUSTER_NAME: your-cluster-name
  GKE_CLUSTER_REGION: your-cluster-region
  HELM_RELEASE_NAME: my-app
  HELM_CHART_PATH: ./charts/my-app
  KUBERNETES_NAMESPACE: default

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read            # ã‚³ãƒ¼ãƒ‰ã¸ã®èª­ã¿å–ã‚Šã‚¢ã‚¯ã‚»ã‚¹
      id-token: write           # Workload Identity Federationç”¨ã®IDãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œã‚’è¨±å¯

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆå–å¾—ï¼‰

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}
        # Workload Identity Federation ã«ã‚ˆã‚‹ GCP èªè¨¼ã‚’å®Ÿè¡Œ

      - name: Set up kubectl
        uses: google-github-actions/setup-gcloud@v1
        # kubectl/gcloud CLI ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

      - name: Authenticate kubectl to GKE
        run: |
          gcloud container clusters get-credentials "$GKE_CLUSTER_NAME" \
            --region "$GKE_CLUSTER_REGION" \
            --project "$GCP_PROJECT_ID"
        # GKEã‚¯ãƒ©ã‚¹ã‚¿ã®èªè¨¼æƒ…å ±ã‚’å–å¾—ã—ã€kubectlãŒä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹

      - name: Set up Helm
        uses: azure/setup-helm@v3
        # Helm CLI ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

      # 5. ãƒªãƒªãƒ¼ã‚¹ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã€å‰Šé™¤ï¼ˆå¼·åˆ¶åŒæœŸï¼‰
      - name: ğŸ§¹ Uninstall existing release (if exists)
        run: |
          if helm status $RELEASE_NAME -n $NAMESPACE > /dev/null 2>&1; then
            echo "Existing release found. Uninstalling..."
            helm uninstall $RELEASE_NAME -n $NAMESPACE
          else
            echo "No existing release found. Skipping uninstall."
          fi

      - name: Helm lint
        run: |
          helm lint "$HELM_CHART_PATH"
        # Helm ãƒãƒ£ãƒ¼ãƒˆã®æ§‹æ–‡ã‚„æ§‹æˆã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹æ¤œè¨¼

      - name: Helm template output
        run: |
          helm template "$HELM_RELEASE_NAME" "$HELM_CHART_PATH" \
            --namespace "$KUBERNETES_NAMESPACE"
        # Helm ãƒãƒ£ãƒ¼ãƒˆã‹ã‚‰æœ€çµ‚çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ Kubernetes ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ç¢ºèªç”¨ã«å‡ºåŠ›

      - name: Helm dry-run (simulate deployment)
        run: |
          helm upgrade --install "$HELM_RELEASE_NAME" "$HELM_CHART_PATH" \
            --namespace "$KUBERNETES_NAMESPACE" \
            --create-namespace \
            --dry-run \
            --debug
        # Helm ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æœ¬ç•ªç’°å¢ƒã«åæ˜ ã›ãšã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆdry-runï¼‰

      - name: Deploy with Helm
        run: |
          helm upgrade --install "$HELM_RELEASE_NAME" "$HELM_CHART_PATH" \
            --namespace "$KUBERNETES_NAMESPACE" \
            --create-namespace \
            --wait
        # Helm ã‚’ä½¿ã£ã¦ GKE ã«å®Ÿéš›ã«ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆãƒªãƒªãƒ¼ã‚¹ãŒãªã‘ã‚Œã° installã€ã‚ã‚Œã° upgradeï¼‰
